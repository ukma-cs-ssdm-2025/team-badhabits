name: Backend API Documentation CI/CD

on:
  push:
    branches: [main, develop]
    paths:
      - 'src/backend/**'
      - 'docs/api/**'
      - '.github/workflows/backend-api-docs.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'src/backend/**'
      - 'docs/api/**'

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  # Job 1: Generate OpenAPI Specification
  generate-openapi:
    name: Generate OpenAPI Spec
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: src/backend/package-lock.json

      - name: Install dependencies
        working-directory: src/backend
        run: npm ci

      - name: Generate OpenAPI specification
        working-directory: src/backend
        run: npm run generate-openapi

      - name: Verify OpenAPI file was generated
        run: |
          if [ ! -f "docs/api/openapi-generated.yaml" ]; then
            echo "Error: OpenAPI file was not generated"
            exit 1
          fi
          echo "OpenAPI file generated successfully"
          ls -lh docs/api/openapi-generated.yaml

      - name: Upload OpenAPI spec artifact
        uses: actions/upload-artifact@v4
        with:
          name: openapi-spec
          path: docs/api/openapi-generated.yaml
          retention-days: 30

  # Job 2: Validate OpenAPI Specification
  validate-openapi:
    name: Validate OpenAPI Spec
    runs-on: ubuntu-latest
    needs: generate-openapi

    steps:
      - name: Checkout repository (for Spectral rules)
        uses: actions/checkout@v4

      - name: Download OpenAPI spec artifact
        uses: actions/download-artifact@v4
        with:
          name: openapi-spec
          path: docs/api/

      - name: Install validation tools
        run: |
          npm install -g @apidevtools/swagger-cli@4.0.4
          npm install -g @stoplight/spectral-cli@6.11.0

      - name: Validate OpenAPI spec with Swagger CLI
        run: |
          echo "ðŸ” Validating OpenAPI specification with Swagger CLI..."
          swagger-cli validate docs/api/openapi-generated.yaml
          echo "âœ… Swagger CLI validation passed"

      - name: Lint OpenAPI spec with Spectral
        run: |
          echo "ðŸ” Linting OpenAPI specification with Spectral..."
          spectral lint docs/api/openapi-generated.yaml \
            --ruleset spectral:oas \
            --format stylish \
            --verbose || echo "âš ï¸ Spectral found some issues (non-blocking)"

      - name: Generate validation report
        if: always()
        run: |
          echo "# OpenAPI Validation Report" > validation-report.md
          echo "" >> validation-report.md
          echo "## File Information" >> validation-report.md
          echo "- **File**: docs/api/openapi-generated.yaml" >> validation-report.md
          echo "- **Size**: $(ls -lh docs/api/openapi-generated.yaml | awk '{print $5}')" >> validation-report.md
          echo "- **Generated**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> validation-report.md
          echo "" >> validation-report.md
          echo "## Validation Status" >> validation-report.md
          echo "- âœ… Swagger CLI: Passed" >> validation-report.md
          echo "- â„¹ï¸ Spectral: See workflow logs" >> validation-report.md
          cat validation-report.md

      - name: Upload validation report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: validation-report
          path: validation-report.md
          retention-days: 30

  # Job 3: Deploy Documentation to GitHub Pages
  deploy-docs:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: [generate-openapi, validate-openapi]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download OpenAPI spec artifact
        uses: actions/download-artifact@v4
        with:
          name: openapi-spec
          path: docs/api/

      - name: Install Redoc CLI
        run: npm install -g redoc-cli@0.13.21

      - name: Generate Redoc HTML documentation
        run: |
          echo "ðŸ“ Generating Redoc HTML documentation..."
          mkdir -p docs/api/public

          redoc-cli bundle docs/api/openapi-generated.yaml \
            -o docs/api/public/index.html \
            --title "Wellity API Documentation" \
            --options.theme.colors.primary.main="#4CAF50" \
            --options.hideDownloadButton=false

          echo "âœ… Redoc HTML generated successfully"
          ls -lh docs/api/public/index.html

      - name: Create documentation index
        run: |
          cat > docs/api/public/README.md << 'EOF'
          # Wellity API Documentation

          **Team BadHabits** | Custom Backend REST API for Wellity - Fitness and Habit Tracking Application

          ## Quick Links

          - ðŸ“– [API Documentation](./index.html)
          - ðŸ“„ [OpenAPI Specification (YAML)](./openapi-generated.yaml)

          ## Documentation Version

          - **Generated**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          - **Commit**: ${{ github.sha }}
          - **Branch**: ${{ github.ref_name }}

          ## Tech Stack

          - Node.js / Express.js
          - Firebase (Firestore, Auth, Realtime Database)
          - Flutter (Mobile Frontend)

          ---

          ðŸ¤– Auto-generated by GitHub Actions
          EOF

          cp docs/api/openapi-generated.yaml docs/api/public/

      - name: Configure GitHub Pages
        uses: actions/configure-pages@v4

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'docs/api/public'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Output deployment URL
        run: |
          echo "ðŸš€ Documentation deployed successfully!"
          echo "ðŸ“– URL: ${{ steps.deployment.outputs.page_url }}"

  # Job 4: Workflow Summary
  workflow-summary:
    name: Workflow Summary
    runs-on: ubuntu-latest
    needs: [generate-openapi, validate-openapi]
    if: always()

    steps:
      - name: Create workflow summary
        run: |
          echo "# ðŸ“Š Backend API Documentation Workflow Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Workflow Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Actor**: @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Job Results" >> $GITHUB_STEP_SUMMARY
          echo "- **Generate OpenAPI**: ${{ needs.generate-openapi.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Validate OpenAPI**: ${{ needs.validate-openapi.result }}" >> $GITHUB_STEP_SUMMARY

          if [ "${{ github.ref }}" == "refs/heads/main" ] && [ "${{ github.event_name }}" == "push" ]; then
            echo "- **Deploy to GitHub Pages**: âœ… Triggered" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Deploy to GitHub Pages**: â­ï¸ Skipped (only runs on main branch)" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Artifacts Generated" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“„ OpenAPI Specification (YAML)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“‹ Validation Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ¤– Generated by GitHub Actions" >> $GITHUB_STEP_SUMMARY
